\documentclass{beamer}
\usetheme{Berkeley}

\usepackage{default}
\usepackage{xspace}
\usepackage{algorithm}
\usepackage[noend]{algpseudocode}
\usepackage{listings}
\usepackage{tikz}
\usepackage{tkz-graph}
\usetikzlibrary{arrows,%
	petri,%
	topaths,
	calc}%
\usepackage{siunitx}
\usepackage{diagbox}

\newcommand{\TODO}[1]{\noindent\textcolor{green}{\textbf{TODO:} #1}}

\newcommand{\pathfinder}{\textsc{Pathfinder}\xspace}
\newcommand{\findEdgeCandidates}{FindEdgeCandidates\xspace}
\newcommand{\refineEdgeCandidates}{RefineEdgeCandidates\xspace}
\newcommand{\getAssociatedTrajectories}{GetAssociatedTrajectories\xspace}
\newcommand{\chrep}{CH-representation\xspace}

\newcommand{\traj}[2]{\mathcal{T}_{\text{#1},\text{#2}}}

\title[Pathfinder] % (optional, only for long titles)
{PATHFINDER}
\subtitle{Storage and Indexing of Massive Trajectory Sets}
\author[Funke, Nusser, Rupp, Storandt] % (optional, for multiple authors)
{S.~Funke\inst{1} \and A.~Nusser\inst{2} \and T.~Rupp\inst{3} \and S.~Storandt\inst{4}}
\institute[Universities] % (optional)
{
	\inst{1}%
	University of Stuttgart
	\and
	\inst{2}%
	Max Planck Institute for Informatics
	\and
	\inst{3}%
	University of Stuttgart
	\and
	\inst{4}%
	University of Konstanz
}
\date[SSTD 2019] % (optional)
{SSTD, 2019}
\subject{Computer Science}


\begin{document}
\frame{\titlepage}

\section{Overview}
\begin{frame}
	\frametitle{Overview}
	\tableofcontents[
		currentsection=show,
		currentsubsection=shaded,
		subsectionstyle=hide
	]
\end{frame}

\section{Problem Description}
\begin{frame}
	\frametitle{Problem Description}
	\begin{itemize}
		\item Given: \pause
		      \begin{itemize}
			      \item road network graph $G(V,E,c)$ \pause
			      \item collection of trajectories $\mathcal{T}$ where $t\in \mathcal{T}$ is a path $v_0 v_1 \dots v_k$ in $G$. \pause
			      \item \emph{window}-query of the form $[x_l, x_u]\times[y_l, y_u]$ \pause
		      \end{itemize}
		\item goal: Return all intersecting trajectories \pause
	\end{itemize}
	\includegraphics[width=0.75\linewidth]{graphics/saarland_real_data_gimp.pdf}
\end{frame}


\section{Preliminaries}
\begin{frame}
	\frametitle{Contraction Hierarchy}
	\begin{itemize}
		\item Contraction Hierarchy (CH) is an augmentation of a graph $G(V,E,c)$ with \emph{shortcuts} and \emph{node levels}. \pause
		\item \emph{Node contraction}: \pause
		      \begin{enumerate}
			      \item Remove a node $v$ and all of its adjacent edges from the graph. \pause
			      \item If $\exists$ shortest path $uvw$ where $u$ and $w$ are adjacent to $v$ \pause

			            $\Rightarrow$ create shortcut $s = (u, w)$ with $c(s) = c(uv) + c(vw)$. \pause
		      \end{enumerate}
		\item Construct CH by successively contracting all nodes. \pause
		\item Final CH data structure is defined as $G(V, E^+, c, l)$ where $E^+$ is the union of $E$ and all shortcuts.
	\end{itemize}
\end{frame}

\begin{frame}
	\frametitle{\chrep}
	\framesubtitle{Compression}
	\begin{figure}
		\caption{Original path (black) and derivation of its \chrep (bold blue) via repeated shortcut substitution. $y$-coordinate corresponds to CH level.}
		\includegraphics[width=.76\columnwidth]{images/toch}
	\end{figure}
\end{frame}

\section{Algorithm}

\begin{frame}
	\frametitle{Algorithm Overview}
	Inverted Index: Associate a trajectory with all edges of its \chrep in $E^+$. \pause
	\begin{algorithm}[H]
		\renewcommand{\thealgorithm}{}
		{\small
			\caption{Spatial \pathfinder Algorithm}
			\begin{algorithmic}[1]
				\Procedure{PathfinderQuery}{$Q$} \pause
				\State $E_O \gets \Call{\findEdgeCandidates}{Q}$ \label{line:edge_revrieval} \pause
				\State $E_r \gets \Call{\refineEdgeCandidates}{Q, E_O}$ \pause
				\State \Return $\Call{\getAssociatedTrajectories}{E_r}$
				\EndProcedure
			\end{algorithmic}
			\label{alg:spatial_pathfinder}
		}
	\end{algorithm}
\end{frame}

%\subsection{\findEdgeCandidates}
\begin{frame}
	\frametitle{\findEdgeCandidates}
	\framesubtitle{Path box}
	\emph{Path box} $PB(e)$: Bounding box for the path that an edge $e$ represents:

	\includegraphics[width=.45\columnwidth]{images/simplePathBox} \pause
	\includegraphics[width=.45\columnwidth]{images/pathBox}
\end{frame}

\begin{frame}
	\frametitle{\findEdgeCandidates}
	\framesubtitle{Downgraph box}
	\emph{Downgraph box} $DB(v)$: Bounding box of all nodes that are reachable from a node $v$ on a down-path (only visiting nodes of decreasing CH-level)
	\includegraphics[width=.76\columnwidth]{images/downgraphBox}
\end{frame}

\begin{frame}
	\frametitle{\findEdgeCandidates}
	\begin{algorithm}[H]
		\renewcommand{\thealgorithm}{}
		{\tiny
			\caption{The algorithm to find edge candidates given a query rectangle $Q$.}
			\begin{algorithmic}[1]
				\Procedure{FindCandidatesForNode}{$v, Q$}
				\State $C \gets \emptyset$
				\For {$e \in \text{down edges of $v$}$}
				\If {$PB(e) \cap Q \neq \emptyset$}
				\State $C \gets C \cup \{e\}$
				\EndIf
				\State $v_l \gets \text{lower node of $e$}$
				\If {$DB(v_l) \cap Q \neq \emptyset$}
				\State $C \gets C \cup \Call{FindCandidatesForNode}{v_l, Q}$
				\EndIf
				\EndFor
				\State \Return $C$
				\EndProcedure
			\end{algorithmic}
		}
	\end{algorithm}
	\includegraphics[width=.45\columnwidth]{images/containedDowngraphBox}
\end{frame}

%\subsection{\refineEdgeCandidates}
\begin{frame}
	\frametitle{\refineEdgeCandidates}
	Problem: Some of the candidates my be false positives. \pause

	Example: Black candidate edge $e$ and red query rectangle
	\begin{tikzpicture}

		\SetGraphUnit{1}

		\GraphInit[vstyle=Classic]
		\tikzset{VertexStyle/.style =
				{shape=circle, fill=black, minimum size = 4pt,inner sep=0pt}
		}

		%edge
		\tikzstyle{EdgeStyle}=[->, color=black]
		\SetVertexNoLabel
		\Vertex[x=-0.5,y=2]{source}
		\Vertex[x=2,y=3.25]{target}

		\Edge(source)(target) {e}


		%edgeBox

		\tikzset{VertexStyle/.style =
				{shape=circle, fill=black, minimum size = 0pt,inner sep=0pt}
		}
		\SetVertexNoLabel
		\Vertex[x=2,y=2]{6}
		\Vertex[x=-0.5,y=3.25]{8}

		\tikzstyle{EdgeStyle}=[color=blue]
		\Edge(source)(6)
		\Edge(6)(target)
		\Edge(target)(8)
		\Edge(8)(source)


		%queryBox
		\Vertex[x=1.25,y=1.75]{1}
		\Vertex[x=3,y=1.75]{2}
		\Vertex[x=3,y=2.75]{3}
		\Vertex[x=1.25,y=2.75]{4}

		\tikzstyle{EdgeStyle}=[color=red]
		\Edge(1)(2)
		\Edge(2)(3)
		\Edge(3)(4)
		\Edge(4)(1)

		%unpacked
		\tikzset{VertexStyle/.style =
				{shape=circle, fill=black, minimum size = 4pt,inner sep=0pt}
		}

		%possibility1
		\Vertex[x=0.5,y=3, LabelOut=true, Lpos=-90]{9}

		\tikzstyle{EdgeStyle}=[->, color=green, dashed]
		\Edge(source)(9)
		\Edge(9)(target)

		%possibility2
		\Vertex[x=1.5,y=2.5, LabelOut=true, Lpos=180]{10}

		\tikzstyle{EdgeStyle}=[->, color=brown, dashed]
		\Edge(source)(10)
		\Edge(10)(target)
	\end{tikzpicture}
	\pause

	Here $e$ is a candidate because of $PB(e) \cap Q \neq \emptyset$. \pause

	If $e$ bridges \pause
	\begin{itemize}
		\item intersecting brown path  $\Rightarrow$ true positive \pause
		\item non-intersecting green path $\Rightarrow$ false positive \pause
	\end{itemize}
	$\Rightarrow$ in doubt, $e$ have to be unpacked recursively
\end{frame}

%\subsection{\getAssociatedTrajectories}
%\begin{frame}
%	\frametitle{\getAssociatedTrajectories}
%	Finally collect all trajectories associated with the remaining candidate edges, i.e. $t \in \bigcup_{e \in E_r} \mathcal{T}_e $.\pause
%
%	Removal of duplicates is also required, as trajectories are associated with more than one edge.
%\end{frame}

\section{Extensions}

\begin{frame}
	\frametitle{Optimization}
	\begin{itemize}
		\item<1-> All 3 substeps can be efficiently parallelized.
		\item<2-> Trajectory data can be stored on disk instead of RAM.
	\end{itemize}
\end{frame}

\begin{frame}
	\frametitle{Time queries}
	\begin{itemize}

		\item	Two types of time queries: \pause
		      \begin{itemize}
			      \item Time frame queries $[\tau_l, \tau_u]$ \pause
			      \item Time slice queries for periodic events, e.g. Friday Evening \pause
		      \end{itemize}

		\item Can be combined with each other and the spatial query. \pause

		\item The compression of time data is lossy.
	\end{itemize}
\end{frame}

\section{Experiments}

\begin{frame}
	\frametitle{Experiments}
	\framesubtitle{Technology}
	\pathfinder was implemented in C++. \pause
	\medskip

	Experiments were conducted on two machines: \pause
	\begin{enumerate}
		\item Ryzen Threadripper 16-Core), 128 GB RAM
		      %AMD Ryzen Threadripper 1950X (16-Core), 128 GB RAM and a 512GB Toshiba OCZ RD400 NVMe SSD (\SI{2.6}{GB}/s) \pause %3.4 GHz turbo: 4GHz
		\item Intel Xeon (24-Core), 768 GB RAM
		      %Intel Xeon(R) CPU E5-2650 v4 (24-Core), 768 GB RAM %turbo 2.9GHz
	\end{enumerate}
\end{frame}

\begin{frame}
	\frametitle{Experiments}
	\framesubtitle{Graph data}
	\begin{table}
		{
			\caption{Characteristics of network graphs, based on Open Street Map(OSM)}
			\begin{tabular}{|l|rr|}
				\hline
				                    & Germany  & Europe
				\\ \hline
				\# nodes            & $57.4M$  & $437.4M$ \\
				\# edges (original) & $121.7M$ & $902.1M$ \\
				%\# edges (CH)              & $248.4M$ & $1694.2M$ \\
				%CH construction time (min) & 16       & 125       \\
				\hline
			\end{tabular}
		}
	\end{table}
\end{frame}

\begin{frame}
	\frametitle{Experiments}
	\framesubtitle{Trajectory data}
	Dataset $\traj{ger}{real}$ of 370k real-world trajectories compiled from OSM-traces.
	\begin{table}
		{
			\begin{tabular}{|l|r|}
				\hline
				                            & $\varnothing$ \\
				\hline
				\# shortest paths           & 11            \\
				length (km)                 & 14.78         \\
				original length (\#edges)   & 347           \\
				compressed length (\#edges) & 37            \\
				\hline
			\end{tabular}
		}
	\end{table}
\end{frame}


\begin{frame}
	\frametitle{Experiments}
	\framesubtitle{Spatial queries}
	\begin{table}
		\caption[Messungen$europe\_10\_24_spatial_nekton$]{Measurements  for $|\traj{eu}{synth}| = 10^7$ with 24 threads for spatial only queries in seconds.}


		\footnotesize
		\centering
		\begin{tabular}{|r||c|c|c|c|c|}
			\hline
			\diagbox[width=40pt]{d}{r} & 1/8   & 1/16  & 1/32
			\\\hline
			25km                       & 0.270 & 0.093 & 0.041 \\
			100km                      & 1.866 & 0.609 & 0.201 \\
			400km                      & 2.124 & 0.685 & 0.222 \\
			\hline
		\end{tabular}
	\end{table}
\end{frame}

\begin{frame}
	\frametitle{Experiments}
	\framesubtitle{Parallelization}
	\begin{figure}
		\centering
		\includegraphics[width=\linewidth]{graphics/normalized_thread_times.png}
		\caption{Table \ref{tab:europe_10m_threadparam_nekton} as a plot with reported times normalized by multiplication with the number of used threads.}
		\label{fig:normalized_thread_times}
	\end{figure}
\end{frame}

%\begin{frame}
%	\frametitle{Experiments}
%	\framesubtitle{Edge-trajectory association}
%	\begin{figure}
%		\caption{Edge-trajectory associations histogram  for $\traj{ger}{real}$.}
%		{\includegraphics[width=0.8\linewidth]{plots/osmGerHist.pdf} }
%	\end{figure}
%\end{frame}

% etc
\end{document}
